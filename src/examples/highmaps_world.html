<!DOCTYPE html>
<html>
<head>
    <style>
        .active { fill: blue !important;}
        /*.datamaps-key dt, .datamaps-key dd {float: none !important;}
        .datamaps-key {right: -50px; top: 0;}*/
        #date_lbl{
            left:auto;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <div id = 'date_lbl'>Week</div>
    <button id = 'play'>Play</button>
</div>
<div id="container1" style="border:1px dotted blue; width: 1080px; height: 786px; position: relative;"></div>

<script src="../js/components/d3/d3.js"></script>
<script src="../js/components/topojson/topojson.js"></script>
<script src="../../dist/datamaps.world.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>

<script>
    // example data from server
    var data = [];
    var dataset = {};
    var only_values = [];
    var palette_scale = [];
    var map = [];
    var idx = 0;
    var dates = [];
    var playing = false;
    function load_data(){
        queue()
        .defer(d3.csv,'countriesRandom.csv')
        .await(cp_data);
        
        function cp_data(error, data){
            for( var j in data){
                //console.log(j);
                for(var k in data[j]){
                    //console.log('k',k);
                    //console.log('k',k);
                    if(k!= 'id'){
                        only_values.push( parseInt(1000000 * parseFloat(data[j][k])));
                    }
                }
            }
            console.log(only_values);
            var minValue = Math.min.apply(null, only_values),
                maxValue = Math.max.apply(null, only_values);
            console.log("minValue ", minValue);
            console.log("maxValue", maxValue);
            palette_scale = d3.scale.linear()
                .domain([minValue,maxValue])
                .range(["#FBB0B0","#FC0404"])
                //.range(["#EFEFFF","#02386F"]); // blue color
            console.log(palette_scale);
            for( var j in data){
                var iso = data[j]['id'];
                for(var k in data[j]){
                    if(k!= 'id'){
                        if(!dataset.hasOwnProperty(k)){
                            dataset[k] = {}
                        }
                        //if(parseFloat(data[j][k] > 0))
                        //console.log(data[j][k]);
                        //console.log(data[j][k]);
                        //if(parseInt(data[j][k]) > 0)
                            //debugger;
                        var num =  parseInt(1000000 * parseFloat(data[j][k]));
                        if (num > 0)
                        //console.log(num)
                            dataset[k][iso] = {numberOfThings: num, fillColor: palette_scale(num)};
                        else
                            dataset[k][iso] = {numberofThings:0, fillColor:'#FFFFFF'};
                    }
                }
            }
            dates = Object.keys(dataset);
            
            console.log(dates[200]);
            console.log(dataset[dates[10]]);
            
            map = new Datamap({
                element: document.getElementById('container1'),
                projection: 'mercator', // big world map
                // countries don't listed in dataset will be painted with this color
                fills: { defaultFill: '#FFFFFF' },
                data: dataset[dates[0]],
                geographyConfig: {
                    borderColor: '#DEDEDE',
                    highlightBorderWidth: 2,
                    // don't change color on mouse hover
                    highlightFillColor: function(geo) {
                        return geo['fillColor'] || '#F5F5F5';
                    },
                    // only change border
                    highlightBorderColor: '#B7B7B7',
                    // show desired information in tooltip
                    popupTemplate: function(geo, data) {
                        // don't show tooltip if country don't present in dataset
                        if (!data) { return ; }
                        // tooltip content
                        return ['<div class="hoverinfo">',
                            '<strong>', geo.properties.name, '</strong>',
                            '<br>Count: <strong>', data.numberOfThings, '</strong>',
                            '</div>'].join('');
                    }
                }
            });
        }
    }
    load_data();
    
    /*window.setInterval(function() {
            idx = (idx + 1) % dates.length;
            //console.log("idx",dates[idx]);
            map.updateChoropleth(dataset[dates[idx]]);
            d3.select("#date_lbl").html(dates[idx]);
    }, 20);*/
    function animateMap(){
        var timer;
        d3.select("#play")
        .on('click', function(){
            if(playing == false){
                timer = setInterval(function(){
                    idx = (idx+1)% dates.length;
                    /*
                    if(idx == dates.length){
                        idx = 0;
                        clearInterval(timer);
                        d3.select(this).html("play");
                        playing = false;
                    }*/
                    map.updateChoropleth(dataset[dates[idx]]);
                    d3.select("#date_lbl").html(dates[idx]);
                },200);
                d3.select(this).html('stop');
                playing = true;
            }
            else{
                clearInterval(timer);
                d3.select(this).html("play");
                playing = false;
            }
        });
    }
    animateMap();
    
    /*
    var series = [
        ["BLR",75],["BLZ",43],["RUS",50],["RWA",88],["SRB",21],["TLS",43],
        ["REU",21],["TKM",19],["TJK",60],["ROU",4],["TKL",44],["GNB",38],
        ["GUM",67],["GTM",2],["SGS",95],["GRC",60],["GNQ",57],["GLP",53],
        ["JPN",59],["GUY",24],["GGY",4],["GUF",21],["GEO",42],["GRD",65],
        ["GBR",14],["GAB",47],["SLV",15],["GIN",19],["GMB",63],["GRL",56],
        ["ERI",57],["MNE",93],["MDA",39],["MDG",71],["MAF",16],["MAR",8],
        ["MCO",25],["UZB",81],["MMR",21],["MLI",95],["MAC",33],["MNG",93],
        ["MHL",15],["MKD",52],["MUS",19],["MLT",69],["MWI",37],["MDV",44],
        ["MTQ",13],["MNP",21],["MSR",89],["MRT",20],["IMN",72],["UGA",59],
        ["TZA",62],["MYS",75],["MEX",80],["ISR",77],["FRA",54],["IOT",56],
        ["SHN",91],["FIN",51],["FJI",22],["FLK",4],["FSM",69],["FRO",70],
        ["NIC",66],["NLD",53],["NOR",7],["NAM",63],["VUT",15],["NCL",66],
        ["NER",34],["NFK",33],["NGA",45],["NZL",96],["NPL",21],["NRU",13],
        ["NIU",6],["COK",19],["XKX",32],["CIV",27],["CHE",65],["COL",64],
        ["CHN",16],["CMR",70],["CHL",15],["CCK",85],["CAN",76],["COG",20],
        ["CAF",93],["COD",36],["CZE",77],["CYP",65],["CXR",14],["CRI",31],
        ["CUW",67],["CPV",63],["CUB",40],["SWZ",58],["SYR",96],["SXM",31]];

    */
    // Datamaps expect data in format:
    // { "USA": { "fillColor": "#42a844", numberOfWhatever: 75},
    //   "FRA": { "fillColor": "#8dc386", numberOfWhatever: 43 } }
    //var dataset = {};

    // We need to colorize every country based on "numberOfWhatever"
    // colors should be uniq for every value.
    // For this purpose we create palette(using min/max series-value)
    //var onlyValues = series.map(function(obj){ return obj[1]; });
    /*
    var minValue = Math.min.apply(null, onlyValues),
            maxValue = Math.max.apply(null, onlyValues);

    // create color palette function
    // color can be whatever you wish
    var paletteScale = d3.scale.linear()
            .domain([minValue,maxValue])
            .range(["#EFEFFF","#02386F"]); // blue color

    // fill dataset in appropriate format
    series.forEach(function(item){ //
        // item example value ["USA", 70]
        var iso = item[0],
                value = item[1];
        dataset[iso] = { numberOfThings: value, fillColor: paletteScale(value) };
    });
    */
    
    
	//map.updateChoropleth({ "USA": { "fillColor": "#42a844", numberOfWhatever: 75}, "FRA": { "fillColor": "#a84442", numberOfWhatever: 43 } }, reset = false);
</script>

</body>
</html>